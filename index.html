<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ´¾å…œç®¡ç†ç³»çµ±</title>
  
  <!-- 1. æ¨£å¼èˆ‡åœ–æ¨™ -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. LINE SDK -->
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- 3. React å¼•æ“è¨­å®š -->
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.300.0"
      }
    }
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* éš±è—æ©«å‘æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* ç¢ºä¿è¼¸å…¥æ¡†åœ¨ iOS ä¸Šé¡¯ç¤ºæ­£å¸¸ */
    input, select { -webkit-appearance: none; }

    /* --- æ’è¡Œæ¦œå‹•ç•«å®šç¾© --- */
    @keyframes pulse-ring {
      0% { transform: scale(0.8); opacity: 0.5; }
      100% { transform: scale(1.3); opacity: 0; }
    }
    .animate-pulse-ring { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }

    @keyframes popIn {
      0% { opacity: 0; transform: scale(0.9) translateY(10px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    .animate-pop-in { animation: popIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-down { animation: slideDown 0.6s ease-out forwards; }

    @keyframes shine {
      0% { background-position: 200% center; }
      100% { background-position: -200% center; }
    }
    .text-shine {
      background: linear-gradient(to right, #fbbf24 20%, #fff 50%, #fbbf24 80%);
      background-size: 200% auto;
      color: #000;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 3s linear infinite;
    }
  </style>
</head>
<body class="bg-[#151716] text-white font-sans antialiased selection:bg-emerald-500/30">
  <div id="root"></div>

  <!-- 4. æ‡‰ç”¨ç¨‹å¼é‚è¼¯ -->
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Calendar, Ship, ChevronRight, Save, 
      CheckCircle2, ArrowRightLeft, AlertTriangle, Loader2, Copy, Lock,
      Trophy, Medal, Frown, Ghost, RefreshCcw, Crown, UserPlus, X,
      Coins, Hand, Sparkles, ChevronDown, Zap
    } from 'lucide-react';

    // --- è¨­å®šå€ ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwRRsL0NVRsOAZQMvKlBC8r4CUejHgSjEIkqTJeTSdS6H3-zP9dUX_0SdOfMMuKF_Tf/exec";
    const LIFF_ID = "2009117946-3B0ycM46";

    // è¼‰å…¥æ™‚çš„éš¨æ©Ÿæ¨™èª
    const LOADING_MSGS = [
      "æ­£åœ¨åŠªåŠ›åˆ’å‘ä¼ºæœå™¨ï¼Œè«‹ç¨å€™...",
      "ç­‰å¾…æ™‚é–“å¯ä»¥åšæ³¢æ¯”è·³åº¦é... 1 ä¸‹ 2 ä¸‹",
      "æ§³é » 30 æ˜¯æœ‰é»æ…¢...",
      "Expect More of Yourself.",
      "Reset to Zero. Paddle for Life."
    ];

    // --- ç¨ç«‹å…ƒä»¶ï¼šConfetti å½©å¸¶ ---
    const Confetti = ({ isActive }) => {
      const canvasRef = useRef(null);
      useEffect(() => {
        if (!isActive) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const particles = [];
        const colors = ['#FFD700', '#10B981', '#F59E0B', '#3B82F6'];
        
        for(let i=0; i<120; i++) {
          particles.push({
            x: canvas.width / 2,
            y: canvas.height / 2 + 50,
            vx: (Math.random() - 0.5) * 15,
            vy: (Math.random() - 1) * 15 - 5,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * 6 + 2,
            rotation: Math.random() * 360
          });
        }
        
        let animationId;
        const render = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particles.forEach((p, index) => {
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.4;
            p.rotation += 5;
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.rotation * Math.PI) / 180);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
            ctx.restore();
            if (p.y > canvas.height) particles.splice(index, 1);
          });
          if (particles.length > 0) animationId = requestAnimationFrame(render);
        };
        render();
        return () => cancelAnimationFrame(animationId);
      }, [isActive]);
      if (!isActive) return null;
      return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-50" />;
    };

    // --- ç¨ç«‹å…ƒä»¶ï¼šè³ªæ„Ÿé›†æ°£æŒ‰éˆ• (SVG Ring) ---
    const ChargeButton = ({ onClick, progress, theme, icon: Icon }) => {
      const radius = 56;
      const stroke = 4;
      const normalizedRadius = radius - stroke * 2;
      const circumference = normalizedRadius * 2 * Math.PI;
      const strokeDashoffset = circumference - (progress / 100) * circumference;

      return (
        <div className="relative flex items-center justify-center">
          {/* å‘¼å¸å…‰æšˆ (èƒŒæ™¯) */}
          <div className={`absolute w-32 h-32 rounded-full ${theme.glow} blur-2xl opacity-20 animate-pulse-ring`} />
          
          {/* æŒ‰éˆ•æœ¬é«” */}
          <button 
            onClick={onClick}
            className="relative w-32 h-32 rounded-full flex items-center justify-center bg-[#151716] shadow-2xl active:scale-95 transition-transform duration-100 group"
          >
            {/* SVG é€²åº¦ç’° */}
            <svg height={radius * 2} width={radius * 2} className="-rotate-90 absolute">
              {/* åº•ç’° */}
              <circle
                stroke="#2a2f2d"
                strokeWidth={stroke}
                fill="transparent"
                r={normalizedRadius}
                cx={radius}
                cy={radius}
              />
              {/* é€²åº¦ç’° */}
              <circle
                stroke="currentColor"
                className={`transition-all duration-300 ease-out ${progress >= 100 ? 'text-white' : theme.ring}`}
                strokeWidth={stroke}
                strokeDasharray={circumference + ' ' + circumference}
                style={{ strokeDashoffset }}
                strokeLinecap="round"
                fill="transparent"
                r={normalizedRadius}
                cx={radius}
                cy={radius}
              />
            </svg>

            {/* ä¸­å¿ƒ Icon */}
            <div className="flex flex-col items-center gap-1 z-10">
              <Icon className={`w-8 h-8 transition-colors duration-300 ${progress >= 100 ? 'text-white' : theme.icon}`} />
              <span className={`text-[10px] font-black tracking-widest uppercase transition-colors duration-300 ${progress >= 100 ? 'text-white' : 'text-gray-500'}`}>
                {progress >= 100 ? 'READY' : `${Math.round(progress)}%`}
              </span>
            </div>
          </button>
        </div>
      );
    };

    const App = () => {
      const [activeTab, setActiveTab] = useState('signup');
      
      // æ’è¡Œæ¦œç‹€æ…‹
      const [leaderboardTab, setLeaderboardTab] = useState('attendance'); 
      const [energy, setEnergy] = useState(0);
      const [unlockedStatus, setUnlockedStatus] = useState({ attendance: false, sponsor: false });
      const [showConfetti, setShowConfetti] = useState(false);

      const [profiles, setProfiles] = useState([]);
      const [practiceDates, setPracticeDates] = useState([]);
      
      // ç‹€æ…‹ 1: å ±åè¡¨ (å¯è®€å¯«) - å°æ‡‰ Attendance_Main
      const [attendance, setAttendance] = useState({});
      const [initialAttendance, setInitialAttendance] = useState({});

      // ç‹€æ…‹ 2: å¯¦éš›æ‰“å¡çµæœ (å”¯è®€) - å°æ‡‰ Attendance_Status_Calc (æº–æ™‚/é²åˆ°...)
      const [realStatus, setRealStatus] = useState({});

      const [currentUser, setCurrentUser] = useState(null);
      const [proxyUser, setProxyUser] = useState(null);
      const [selectedDate, setSelectedDate] = useState('');
      const [loading, setLoading] = useState(true);
      const [isRefreshing, setIsRefreshing] = useState(false);
      const [errorMsg, setErrorMsg] = useState(null);
      const [isSaving, setIsSaving] = useState(false);
      const [toast, setToast] = useState(null);

      // è¨»å†Šæ–°ç”¨æˆ¶ç‹€æ…‹
      const [isRegistering, setIsRegistering] = useState(false);
      const [newUserName, setNewUserName] = useState('');

      // æœˆä»½ç‹€æ…‹
      const [selectedMonth, setSelectedMonth] = useState(null);
      const [bindingTarget, setBindingTarget] = useState(null);
      const [msgIndex, setMsgIndex] = useState(0);

      // æ’è¡Œæ¦œé¡è‰²ä¸»é¡Œ
      const THEMES = {
        attendance: {
          glow: 'bg-emerald-500',
          ring: 'text-emerald-500',
          icon: 'text-emerald-500 group-hover:text-emerald-400'
        },
        sponsor: {
          glow: 'bg-orange-500',
          ring: 'text-orange-500',
          icon: 'text-orange-500 group-hover:text-orange-400'
        }
      };

      // è¼‰å…¥è¨Šæ¯è¼ªæ’­
      useEffect(() => {
        if (loading) {
          const interval = setInterval(() => {
            setMsgIndex((prev) => (prev + 1) % LOADING_MSGS.length);
          }, 2500);
          return () => clearInterval(interval);
        }
      }, [loading]);

      // æ’è¡Œæ¦œé›†æ°£é‡ç½®é‚è¼¯ï¼šåˆ‡æ› Tab æ™‚æ­¸é›¶èƒ½é‡ï¼Œä½†ä¸é‡ç½®è§£é–ç‹€æ…‹
      useEffect(() => {
        setEnergy(0);
        setShowConfetti(false);
      }, [leaderboardTab]);

      const fetchData = async () => {
        try {
          const res = await fetch(`${API_URL}?action=getInitialData`);
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          return data;
        } catch (err) {
          throw err;
        }
      };

      useEffect(() => {
        const init = async () => {
          try {
            if (LIFF_ID && window.liff) {
              await window.liff.init({ liffId: LIFF_ID });
              if (!window.liff.isLoggedIn()) {
                window.liff.login();
                return;
              }
            }
            
            const userId = (LIFF_ID && window.liff && window.liff.isLoggedIn()) 
              ? (await window.liff.getProfile()).userId 
              : "MOCK_USER_ID";
            
            const data = await fetchData();

            setProfiles(data.profiles);
            setPracticeDates(data.dates);
            
            // è¨­å®šå ±åç‹€æ…‹ (ç”¨æ–¼æ‰“å‹¾)
            const attMap = data.attendanceMap || {};
            setAttendance(attMap);
            setInitialAttendance(JSON.parse(JSON.stringify(attMap)));

            // è¨­å®šå¯¦éš›æ‰“å¡ç‹€æ…‹ (ç”¨æ–¼çœ‹æ¿ Badge & æ’è¡Œæ¦œ)
            const checkInMap = data.checkInMap || {};
            setRealStatus(checkInMap);
            
            if (data.dates.length > 0) {
              // æ™ºæ…§é è¨­æ—¥æœŸ
              let bestDate = data.dates[0];
              try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let minDiff = Infinity;
                data.dates.forEach(dStr => {
                   const s = String(dStr);
                   if (s.includes('/')) {
                     const [m, d] = s.split('/').map(n => parseInt(n, 10));
                     let target = new Date(today.getFullYear(), m - 1, d);
                     const diff = Math.abs(target - today);
                     if (diff < minDiff) {
                       minDiff = diff;
                       bestDate = dStr;
                     }
                   }
                });
              } catch(e) { console.error("Smart default date error", e); }
              
              setSelectedDate(bestDate);

              try {
                const months = [...new Set(data.dates.map(d => {
                  const str = String(d);
                  return str.includes('/') ? parseInt(str.split('/')[0], 10) : null;
                }))].filter(m => m !== null).sort((a,b) => a-b);

                const currentMonth = new Date().getMonth() + 1;
                if (months.includes(currentMonth)) {
                  setSelectedMonth(currentMonth);
                } else if (months.length > 0) {
                  setSelectedMonth(months[0]);
                }
              } catch (e) { console.error("Month init error", e); }
            }

            const boundUser = data.profiles.find(p => p.lineId === userId);
            if (boundUser) {
              setCurrentUser(boundUser);
              setProxyUser(boundUser);
            }
            setLoading(false);
          } catch (err) {
            console.error(err);
            setErrorMsg("é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèª GAS æ¬Šé™è¨­ç‚ºã€Œä»»ä½•äººã€ä¸”ç¶²å€æ­£ç¢ºã€‚");
            setLoading(false);
          }
        };
        init();
      }, []);

      // Handler: é‡æ–°æ•´ç†
      const handleRefresh = async () => {
        setIsRefreshing(true);
        try {
          const data = await fetchData();
          setProfiles(data.profiles);
          setPracticeDates(data.dates);
          
          setAttendance(data.attendanceMap || {});
          setInitialAttendance(JSON.parse(JSON.stringify(data.attendanceMap || {})));
          setRealStatus(data.checkInMap || {}); 

          showToast("è³‡æ–™å·²æ›´æ–°");
        } catch (err) {
          showToast("æ›´æ–°å¤±æ•—");
        } finally {
          setIsRefreshing(false);
        }
      };

      // Handler: ç¶å®š
      const handleBindUser = async (name) => {
        if (isSaving) return;
        setIsSaving(true);
        setBindingTarget(name);
        try {
          const userId = (LIFF_ID && window.liff) ? (await window.liff.getProfile()).userId : "MOCK_USER_ID";
          await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'bindLineId', name, lineId: userId })
          });
          const user = profiles.find(p => p.name === name);
          setCurrentUser(user);
          setProxyUser(user);
          showToast(`æ­¡è¿ï¼Œ${name}ï¼å·²ç¶å®šã€‚`);
        } catch (err) { alert("ç¶å®šå¤±æ•—"); } 
        finally { 
          setIsSaving(false); 
          setBindingTarget(null);
        }
      };

      // Handler: è¨»å†Šæ–°ç”¨æˆ¶
      const handleRegister = async () => {
        if (!newUserName.trim()) { alert("è«‹è¼¸å…¥å§“å"); return; }
        setIsSaving(true);
        try {
          const userId = (LIFF_ID && window.liff) ? (await window.liff.getProfile()).userId : "MOCK_USER_ID";
          await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'register', name: newUserName.trim(), lineId: userId })
          });
          showToast(`è¨»å†ŠæˆåŠŸï¼æ­¡è¿ ${newUserName}`);
          const data = await fetchData();
          setProfiles(data.profiles);
          setPracticeDates(data.dates);
          setAttendance(data.attendanceMap || {});
          setInitialAttendance(JSON.parse(JSON.stringify(data.attendanceMap || {})));
          const newUser = data.profiles.find(p => p.name === newUserName.trim());
          if (newUser) {
            setCurrentUser(newUser);
            setProxyUser(newUser);
          }
          setIsRegistering(false);
        } catch (err) {
          alert("è¨»å†Šå¤±æ•—");
        } finally {
          setIsSaving(false);
        }
      };

      // Handler: é›†æ°£æŒ‰éˆ•
      const handleCharge = () => {
        if (unlockedStatus[leaderboardTab]) return;
        if (navigator.vibrate) navigator.vibrate(30);

        const newEnergy = Math.min(energy + 20, 100);
        setEnergy(newEnergy);

        if (newEnergy >= 100) {
          if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
          setTimeout(() => {
            setUnlockedStatus(prev => ({ ...prev, [leaderboardTab]: true }));
            setShowConfetti(true);
            setTimeout(() => setShowConfetti(false), 3000);
          }, 300);
        }
      };

      const isDateLocked = (dateStr) => {
        try {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const cleanDate = dateStr.split('(')[0];
          const [m, d] = cleanDate.split('/').map(n => parseInt(n, 10));
          const year = today.getFullYear();
          const targetDate = new Date(year, m - 1, d);
          if (today.getMonth() === 11 && m === 1) targetDate.setFullYear(year + 1);
          return targetDate <= today;
        } catch (e) { return false; }
      };

      const hasUnsavedChanges = useMemo(() => {
        if (!proxyUser) return false;
        return practiceDates.some(date => {
           const key = `${proxyUser.name}_${date}`;
           const current = attendance[key] || 'ä¸åƒåŠ ';
           const initial = initialAttendance[key] || 'ä¸åƒåŠ ';
           return current !== initial;
        });
      }, [attendance, initialAttendance, proxyUser, practiceDates]);

      const handleUpdate = async () => {
        setIsSaving(true);
        try {
          const updates = {};
          practiceDates.forEach(date => {
            updates[date] = attendance[`${proxyUser.name}_${date}`] || 'ä¸åƒåŠ ';
          });
          await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'updateAttendance', name: proxyUser.name, updates })
          });
          setInitialAttendance({...attendance});
          showToast('å·²å„²å­˜ï¼');
        } catch (err) { alert("å„²å­˜å¤±æ•—"); } 
        finally { setIsSaving(false); }
      };

      const handleCopyExcel = () => {
        const { Left, Right, Staff } = dashboardStats.manifest;
        const maxLen = Math.max(Left.length, Right.length, Staff.length);
        let text = `${selectedDate}\n\n`; 
        for(let i=0; i<maxLen; i++) {
          const l = Left[i] ? Left[i].name : "";
          const r = Right[i] ? Right[i].name : "";
          const s = Staff[i] ? Staff[i].name : "";
          text += `${l}\t${r}\t${s}\n`;
        }
        const doCopy = (txt) => {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(txt).then(() => showToast("åå–®å·²è¤‡è£½")).catch(() => fallbackCopy(txt));
            } else { fallbackCopy(txt); }
        };
        const fallbackCopy = (txt) => {
            const textArea = document.createElement("textarea");
            textArea.value = txt;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); showToast("åå–®å·²è¤‡è£½"); } catch (err) { alert("è¤‡è£½å¤±æ•—"); }
            document.body.removeChild(textArea);
        };
        doCopy(text);
      };

      const toggleAttendance = (date) => {
        if (isDateLocked(date)) return;
        const key = `${proxyUser.name}_${date}`;
        const currentVal = attendance[key];
        const isAttending = ['åƒåŠ ', 'æº–æ™‚', 'é²åˆ°'].includes(currentVal);
        setAttendance(prev => ({ ...prev, [key]: isAttending ? 'ä¸åƒåŠ ' : 'åƒåŠ ' }));
      };

      const showToast = (msg) => {
        setToast(msg);
        setTimeout(() => setToast(null), 3000);
      };

      const availableMonths = useMemo(() => {
        if (!practiceDates.length) return [];
        const months = new Set();
        practiceDates.forEach(d => {
            const str = String(d);
            if(str.includes('/')) months.add(parseInt(str.split('/')[0], 10));
        });
        return Array.from(months).sort((a, b) => a - b);
      }, [practiceDates]);

      const filteredDates = useMemo(() => {
        if (!selectedMonth) return practiceDates;
        return practiceDates.filter(d => {
            const str = String(d);
            return str.includes('/') && parseInt(str.split('/')[0], 10) === selectedMonth;
        });
      }, [selectedMonth, practiceDates]);

      const getFinalStatus = (name, date) => {
        const key = `${name}_${date}`;
        const calculated = realStatus[key];
        if (calculated && calculated !== 'ä¸åƒåŠ ') return calculated;
        const registered = attendance[key];
        return registered || 'ä¸åƒåŠ ';
      };

      const isConsideredAttending = (status) => {
        return ['åƒåŠ ', 'æº–æ™‚', 'é²åˆ°', 'æœªæ‰“å¡'].includes(status);
      };

      const dashboardStats = useMemo(() => {
        const attendees = profiles.filter(p => {
          const status = getFinalStatus(p.name, selectedDate);
          return isConsideredAttending(status);
        });
        const male = attendees.filter(p => p.gender === 'ç”·').length;
        const female = attendees.filter(p => p.gender === 'å¥³').length;
        const manifest = {
          Left: attendees.filter(p => p.position && p.position.includes('å·¦')),
          Right: attendees.filter(p => p.position && p.position.includes('å³')),
          Staff: attendees.filter(p => p.position && (p.position.includes('èˆµ') || p.position.includes('é¼“'))),
        };
        return { total: attendees.length, male, female, manifest };
      }, [selectedDate, attendance, realStatus, profiles]);

      // --- æ’è¡Œæ¦œæ•¸æ“šè¨ˆç®—é‚è¼¯ ---
      const leaderboardData = useMemo(() => {
        const stats = profiles.map(p => {
          let attendCount = 0;
          let lateCount = 0;
          practiceDates.forEach(date => {
            if (isDateLocked(date)) {
              const status = getFinalStatus(p.name, date);
              if (['åƒåŠ ', 'æº–æ™‚', 'é²åˆ°'].includes(status)) attendCount++;
              if (status === 'é²åˆ°') lateCount++;
            }
          });
          return { name: p.name, attendCount: attendCount || 0, lateCount: lateCount || 0 };
        });

        // æ’åè¨ˆç®— (è™•ç†ä¸¦åˆ—)
        const calculateRank = (data, key) => {
          const sorted = [...data]
            .filter(item => item[key] > 0)
            .sort((a, b) => b[key] - a[key]);
          
          let currentRank = 1;
          return sorted.map((item, index) => {
            const prevItem = sorted[index - 1];
            if (index > 0 && prevItem && item[key] < prevItem[key]) {
              currentRank = index + 1;
            }
            return { ...item, rank: currentRank };
          });
        };

        const lateRanked = calculateRank(stats, 'lateCount');
        const attendRanked = calculateRank(stats, 'attendCount');

        return {
          attendance: attendRanked,
          sponsor: lateRanked
        };
      }, [profiles, practiceDates, attendance, realStatus]);

      // --- æ¸²æŸ“å…ƒä»¶ï¼šç‹€æ…‹ Badge ---
      const StatusBadge = ({ name }) => {
        const status = getFinalStatus(name, selectedDate);
        if (status === 'æº–æ™‚') {
          return (
            <div className="flex items-center gap-1 px-2 py-1 bg-emerald-500/20 rounded-md border border-emerald-500/30">
              <CheckCircle2 className="w-3 h-3 text-emerald-500" />
              <span className="text-xs font-bold text-emerald-400">æº–æ™‚</span>
            </div>
          );
        }
        if (status === 'é²åˆ°') {
          return (
            <div className="flex items-center gap-1 px-2 py-1 bg-orange-500/20 rounded-md border border-orange-500/30">
              <Frown className="w-3 h-3 text-orange-500" />
              <span className="text-xs font-bold text-orange-400">é²åˆ°</span>
            </div>
          );
        }
        return null;
      };

      // --- æ¸²æŸ“å…ƒä»¶ï¼šæ¦®è€€æ®¿å ‚ (å‡ºå¸­æ¦œ) ---
      const renderAttendanceBoard = () => {
        const top10List = leaderboardData.attendance.filter(p => p.rank <= 10);
        const top3 = top10List.slice(0, 3);
        const others = top10List.slice(3);

        if (leaderboardData.attendance.length === 0) {
           return <div className="text-center text-gray-500 py-10">ç›®å‰æ²’æœ‰æ•¸æ“š</div>;
        }

        return (
          <div className="space-y-6 animate-slide-down pb-20">
            {/* å‰ä¸‰å */}
            <div className="grid grid-cols-3 gap-2 items-end mb-8 pt-8 px-2">
              {/* ç¬¬äºŒå */}
              {top3[1] && (
                <div className="bg-[#1C1F1E] border border-gray-700/50 rounded-xl p-3 flex flex-col items-center shadow-lg relative order-1 animate-pop-in" style={{animationDelay: '0.1s'}}>
                  <div className="absolute -top-3 w-6 h-6 bg-gray-400 rounded-full flex items-center justify-center border-2 border-[#1C1F1E] shadow-lg text-[10px] font-black text-black">2</div>
                  <div className="mt-2 text-center w-full">
                    <div className="text-xs font-bold truncate text-gray-300">{top3[1].name}</div>
                    <div className="text-sm font-black text-emerald-500">{top3[1].attendCount}</div>
                  </div>
                </div>
              )}
              {/* ç¬¬ä¸€å */}
              {top3[0] && (
                <div className="bg-gradient-to-b from-[#1C1F1E] to-[#064E3B] border border-emerald-500/50 rounded-xl p-4 flex flex-col items-center shadow-[0_0_30px_rgba(16,185,129,0.2)] relative order-2 transform -translate-y-4 z-10 animate-pop-in">
                  <div className="absolute -top-5">
                    <Crown className="w-8 h-8 text-yellow-400 drop-shadow-lg fill-yellow-400" />
                  </div>
                  <div className="mt-4 text-center w-full">
                    <div className="text-[10px] text-yellow-400 font-black tracking-widest uppercase mb-1">MVP</div>
                    <div className="text-base font-black truncate w-full text-white">{top3[0].name}</div>
                    <div className="text-3xl font-black text-white mt-1">{top3[0].attendCount}</div>
                  </div>
                </div>
              )}
              {/* ç¬¬ä¸‰å */}
              {top3[2] && (
                <div className="bg-[#1C1F1E] border border-amber-900/50 rounded-xl p-3 flex flex-col items-center shadow-lg relative order-3 animate-pop-in" style={{animationDelay: '0.2s'}}>
                  <div className="absolute -top-3 w-6 h-6 bg-amber-700 rounded-full flex items-center justify-center border-2 border-[#1C1F1E] shadow-lg text-[10px] font-black text-white">3</div>
                  <div className="mt-2 text-center w-full">
                    <div className="text-xs font-bold truncate text-gray-300">{top3[2].name}</div>
                    <div className="text-sm font-black text-emerald-500">{top3[2].attendCount}</div>
                  </div>
                </div>
              )}
            </div>

            {/* 4-10 å */}
            {others.length > 0 && (
              <div className="bg-[#171C1A] border border-emerald-900/30 rounded-2xl overflow-hidden animate-pop-in" style={{animationDelay: '0.3s'}}>
                <div className="px-4 py-3 bg-[#0d1f18] border-b border-emerald-900/30 flex justify-between items-center">
                  <span className="text-xs font-bold text-gray-500 uppercase tracking-wider">èè‹±æ¦œ (Top 10)</span>
                  <Trophy className="w-3 h-3 text-emerald-600" />
                </div>
                {others.map((item, idx) => (
                  <div key={item.name} className="flex items-center justify-between p-4 border-b border-emerald-900/10 last:border-0 hover:bg-[#1a201e] transition-colors">
                    <div className="flex items-center gap-4">
                      <div className="w-6 text-center font-bold text-gray-600 text-sm">#{item.rank}</div>
                      <div className="font-bold text-gray-300">{item.name}</div>
                    </div>
                    <div className="font-bold text-emerald-500/80">{item.attendCount} <span className="text-[10px] text-gray-600 font-normal">æ¬¡</span></div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      };

      // --- æ¸²æŸ“å…ƒä»¶ï¼šè´ŠåŠ©æ¦œ ---
      const renderSponsorBoard = () => {
        if (leaderboardData.sponsor.length === 0) {
           return (
             <div className="p-12 flex flex-col items-center justify-center text-center space-y-4 animate-pop-in">
                <div className="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mb-2">
                   <Crown className="w-8 h-8 text-emerald-500" />
                </div>
                <div className="text-xl font-bold text-emerald-400">ç›®å‰ç„¡äººé²åˆ°ï¼</div>
                <div className="text-sm text-gray-500">å¤§å®¶éƒ½å¾ˆæº–æ™‚ï¼Œè«‹ç¹¼çºŒä¿æŒ ğŸ‘</div>
             </div>
           );
        }

        return (
          <div className="space-y-4 animate-slide-down pb-20">
            <div className="text-center mb-6 pt-4">
              <h2 className="text-xl font-black text-white drop-shadow-sm flex items-center justify-center gap-2">
                <span className="text-orange-500">ğŸ†</span> æ„Ÿè¬è´ŠåŠ©å¤©ä½¿ <span className="text-orange-500">ğŸ†</span>
              </h2>
            </div>

            <div className="bg-[#1C1815] border border-orange-900/30 rounded-2xl overflow-hidden animate-pop-in">
              {leaderboardData.sponsor.map((item, idx) => (
                <div key={item.name} className="flex items-center justify-between p-4 border-b border-orange-900/10 last:border-0 relative overflow-hidden group">
                  <div className="absolute inset-0 bg-gradient-to-r from-orange-500/5 to-transparent translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-500" />
                  <div className="flex items-center gap-4 relative z-10 pl-2">
                    <div className="font-bold text-gray-200 text-lg">{item.name}</div>
                  </div>
                  <div className="text-right relative z-10">
                    <div className="flex items-center gap-1 text-yellow-500 font-black text-lg">
                      <Coins className="w-3 h-3" />
                      ${item.lateCount * 50}
                    </div>
                  </div>
                </div>
              ))}
            </div>
            
            <div className="bg-gradient-to-r from-orange-900/30 to-amber-900/30 rounded-xl p-4 border border-orange-500/20 text-center animate-pop-in" style={{animationDelay: '0.2s'}}>
              <div className="text-[10px] text-orange-400/70 font-bold uppercase mb-1 tracking-widest">ç›®å‰ç´¯ç©éšŠè²»åŸºé‡‘</div>
              <div className="text-2xl font-black text-white text-shine">
                $ {leaderboardData.sponsor.reduce((acc, curr) => acc + (curr.lateCount * 50), 0)}
              </div>
            </div>
          </div>
        );
      };

      // --- Loading ç•«é¢ ---
      if (loading) return (
        <div className="min-h-screen w-full flex flex-col items-center justify-center bg-[#151716] relative overflow-hidden">
          <div className="flex-1 flex flex-col items-center justify-center w-full px-8 space-y-10 -mt-16">
            <div className="w-full max-w-[320px]">
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 128" className="w-full h-auto drop-shadow-[0_0_8px_rgba(1,177,165,0.4)]">
                  <g fill="#01b1a5">
                    <path d="M125.5 68.9q3.6-.1 7.2.2c9.6 1.4 11 9.6 9.7 17.8l-2.2 13c-1.4 8.8-1.8 18.7-9.7 24.4a17 17 0 0 1-6 2.5c-2.5.4-6 .3-8.5.3h-11.4l1.5-8.5 2.7-16.4 5.7-33.3zm4.4 11c-1.8-1.1-3.2-1-5.3-.9l-4.6 26.6c-.6 3.5-1.2 7.6-1.9 11 2.3.1 3.7.3 5.7-.7 2.5-2.1 2.8-6 3.4-9.2l2-11.5q1-5.4 1.7-10.9.4-2.4-1-4.4M266.3 69a16 16 0 0 1 11.1 3c2.7 2.2 3.6 5.1 4 8.4a26 26 0 0 1-.1 5c-.5 4-1.5 8.5-2.2 12.6-2.2 13-2.6 27.6-19.3 28.9h-.2c-3.6.3-8.4-.5-11.2-3-5.8-5-4-13.3-2.8-20l1.6-9 1.4-8.3c1.7-10.3 7-16.8 17.7-17.6m-1 10.2c-1.5.5-3 1.3-3.6 2.9q-1.2 3.2-1.6 6.7-2 11-3.7 22.3c-.5 3.3.4 5.8 4.3 5.3 3-1 4-3.2 4.5-6.2q2.2-12.6 4.3-25.1c.5-3.4-.2-6.1-4.1-6M234 .1c10.5-1 16.6 4.4 15.4 15.1-1 8.3-2.7 16.6-3.8 24.8-1.3 10.2-5 17-15.7 18.5-7.5.4-14-1.6-15.3-10-.6-3.6.2-7.3.8-11l1.7-10.4C219 15.2 219 2.2 234 0m.6 10.1c-2.9.8-4 2.6-4.5 5.5-.8 4.8-1.6 9-2.3 13.9-.7 5.1-2.4 11.5-1.8 16.6.2 1.6 2.3 2 3.7 2q2.2-.4 3.4-2.5c1-2 4.7-25.9 5-29.6.1-1.1.3-2.7 0-3.8a3 3 0 0 0-1.7-1.8 4 4 0 0 0-1.8-.3M384.1 0c3.7-.2 7.8.2 10.7 2.6 5.8 4.8 3.9 13 2.9 19.3L396 32c-1.8 11.7-2.2 24.9-17.4 26.3-7.3.6-14-2.7-14.6-10.5-.2-6.1 1.3-12.7 2.3-18.7C368.4 16.6 368 1.8 384 0m-.4 10.3c-2.8.8-3.9 2.9-4.3 5.6l-4.2 27c-.5 3.5.3 5.5 4.2 5.3a5 5 0 0 0 3-2.5c1.2-2.6 5-26.5 5.2-30.2 0-1 .1-2.4-.2-3.3q-.5-1.2-1.6-1.7-1-.4-2.1-.2M300.5 69.8c2.7 0 5.3-.2 8 .3 10.3 2 9.6 11.8 7.9 19.8-1.1 5-3 9-7.4 12l.4 3.3q1.4 10.5 2.6 20.9H300l-1-9.3-1-11.9h-3.4l-.6 3.2c-.8 5.9-2.4 12-3 18h-12l3-17.7 6.9-38.6zm-1.7 9.8c-.8 5-2 10.5-2.6 15.4 2 0 4 .2 5.6-.8q1.9-1.6 2.5-4.1c.7-3.1 2.7-10.4-2.6-10.4zM19 1c5.9-.2 13.2-.4 18.8.2 9.4.9 9.9 10.8 8.4 18-1.2 6-2 10.3-7.4 14l3.3 24.4H30.4c-.4-2.6-.7-6.8-1-9.5l-1.3-12h-3.3l-3.3 21.5H10c.2-2.1.8-5.2 1.1-7.4l2-12.5zm9.9 9.9c-.4.6-2.2 13.3-2.5 15.3 2 0 3.8.3 5.6-.7 2.6-2.2 3-6.2 3.3-9.5.5-5.3-2.3-5.2-6.4-5.1M349 1q3.5-.2 6.7.1c9.8 1.3 9.9 10.4 8.5 18-1 5.9-2 10.3-7 14 0 2.3.7 6.5 1 9l2 15.4h-11.5l-1-10.1c-.5-3.4-.9-8-1.2-11.4h-3.3c-.8 6.9-2.1 14.6-3.2 21.5h-11l1-6.5 1.7-11.2 6-38.9zm3.2 10.3c-1.8-.6-3.2-.4-5-.4q-.8 4.4-1.5 9c-.2 1.7-.8 4.6-.9 6.2 2.2 0 4 .4 5.8-.9 2-2 2.3-4.9 2.7-7.5.3-2.2.6-4.6-1-6.4M49.7 68.9h15.1c0 19.3.7 38.9 1 58.2H53.6l.2-10h-8.9L42 127H30.1c2-6.4 4.6-13.8 6.8-20.2zm40 0c5.3 0 11.3-.4 15 4.4 3.6 5 2.4 12 1.2 17.8-1.7 8.7-2.2 18.3-5.5 26.5-1.1 2.7-3.4 5-5.6 6.7-5.5 3.2-8.8 2.8-14.9 2.8h-11c.6-5.6 2.2-13.5 3.2-19.2l6.7-39zM94.3 80c-1-1.3-4-1-5.5-1Q87.2 89 85.4 99l-3 17.7c2 0 3.7.2 5.6-.8 2.7-2.2 3-7 3.6-10.3l1.9-11.1.9-5.2c.4-2.6 1.6-6.8 0-9.2m-39.5 3.3a574 574 0 0 0-6.5 23.4H54l.6-15.3c0-1.6.4-6.8.2-8.1M298.5 1h34.7c-.7 3.3-1.2 7.3-1.7 10.7h-23.9L306 23.4c7.2.2 14.9 0 22.1 0l-1.5 10.4c-7.2.2-15 0-22.2 0l-.7 4.6-1.4 8.5h24.3l-1.6 10.6h-35.3c1-4.5 1.5-9.9 2.3-14.5 2.3-14 4.1-28.1 6.6-42M20.1 68.9c5 0 11.8-.6 15.7 3.2 4 4.1 3 11.2 2 16.3-.9 5-1.9 10.9-5.6 14.7-4.8 5-10.7 4.6-17 4.6l-.9 5.4c-.7 4.2-1.8 9.8-2.2 14H0L2.7 112l7.4-43zm6.4 12c-.6-2.4-4.6-2-6.4-1.9-.9 5.8-2.5 13-3 18.4 2 0 3.9.3 5.8-.7 1.7-1.5 2.3-3.9 2.6-6 .6-3.1 1.7-6.6 1-9.7M114.3.9h33.2q-1 5.4-1.7 10.6c-7.2.2-14.8 0-22 0-.7 3-1.4 8.7-2 12h20.3l-1.6 10.4h-20.3c-.5 2-.8 5-1.2 7l-.8 6h22.7l-1.6 10.7h-34zM92.9.1c5-.3 10.3.2 13.3 4.7 2.7 4.3 1.8 9.6.9 14.2q-5.4.1-11 .4c.5-2.2 2.3-9.3-1.9-9.4-3.2 0-4.8 3.9-4.6 6.7.3 3.3 2.6 5 5 7 4.6 3.6 9.5 7.2 9.6 13.6.2 10.9-4.2 20.6-16.2 21.2-4.5.1-9.3-.4-12.2-4.4-3.3-4.8-2-10.5-1-15.8q5.3-.1 10.9-.3-.7 3.3-.9 6.8c0 4.3 4.2 4.5 6.5 1.6 1.3-1.6 1.7-5.8.7-7.7-2.7-4.8-8.5-7-11.5-11.6-2.4-3.5-2.6-6.4-2.2-10.5C79.1 7.7 83.7 1.3 93 .1M180 68.9H205c-.2 2.5-1.3 8-1.8 10.8H190c-.7 3.6-1.5 8.4-2 12.1h11.4c-.4 3.4-1.2 7.2-1.8 10.6H186c-.6 4.3-1.6 9.4-2.3 13.8h14q-1 5.4-1.8 10.9h-25.9c.6-4.8 1.9-11.1 2.7-16l4.5-25.7zM414.4 69.8h25.2l-1.8 10.5c-4.1.2-9.2 0-13.4.1-.5 3.5-1.3 7.7-2 11.3H434L432 102h-11.5l-2.3 13.2h13.9c-.7 3.4-1.2 7.3-1.8 10.8h-25.9q1.4-9 3.2-18.1zM53.5.9h24l-1.7 10.7H63L61.2 23h11.1l-1.6 10.5H59.5l-2 13.2h13.2L69 57.6H44.5zM268.4 1h26c-.4 1.7-1 8.2-1.7 9.3-6.3 12.3-13.5 24.3-19.9 36.5 4.4.2 10.3 0 14.7 0L286 57.6q-13.4-.2-26.9 0c.3-1.6 1.2-8.6 1.7-9.7q9.7-18.1 19.9-36.1h-13.8c.3-3.4 1-7.4 1.6-10.8M223.2 69.8h25.5L247 80.3c-4.4.2-9.4 0-13.8.1l-2 11.8h11.7c-.4 3-1.2 7.5-1.8 10.5h-11.8l-.2 1.8-2.3 12.9-1.5 8.7h-12c1-6.7 2.4-13.8 3.6-20.5q3-18 6.4-35.8M384.9 69.8h25.6l-1.8 10.6H395c-.7 3.6-1.5 8.1-2 11.8h11.7c-.4 3.1-1.2 7.4-1.9 10.5H391l-.3 1.9-3.8 21.5h-12c1.6-7.7 3-16.4 4.3-24.2zM150.3 68.9H162c-2.9 15.6-5.3 31.6-8.1 47.3h13.9q-.9 5.4-1.8 10.9h-25.8c2.5-12.8 4.3-26 6.6-38.8q1.9-9.7 3.3-19.4M191.2.9h28.3c-.7 2.9-1.3 7.6-1.7 10.6h-8.6c-1.8 13-4.1 25.8-6 38.6l-1.2 7.5h-11.3l7.3-46h-8.5zM337.8 69.8h12c-3 15-5 30.6-8 45.4h14q-1 5.4-2 10.8c-1.4.2-6.6 0-8.2 0H328c1-6.7 2.4-13.8 3.6-20.5l3.9-22.3q1.3-6.7 2.3-13.4M149.7.9h28c-.1 2.8-1 7.8-1.6 10.7h-8.4l-6.1 38.8-1 7.2h-11.4l7.3-46H148c.6-3 1.3-7.6 1.7-10.7M367.5 69.8h11.8l-1 6.7-2.3 12.8c-2 12.1-4.2 24.7-6.4 36.8h-12l1.4-7.9L361 106zM436.4 113h11.5c-.6 4.2-1.5 8.8-2.2 13h-11.5c.8-3.8 1.5-9.1 2.2-13M397.3 44.8H408l-2 12.7h-11z"/></g>
               </svg>
            </div>
          </div>
          <div className="flex-none pb-12 w-full text-center">
            <p className="text-[#2d5c4d] text-sm font-medium animate-pulse transition-all duration-500 tracking-wider">
              {LOADING_MSGS[msgIndex]}
            </p>
          </div>
        </div>
      );
      
      if (errorMsg) return (
        <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
          <AlertTriangle className="w-16 h-16 text-yellow-500 mb-4" />
          <p className="text-gray-400">{errorMsg}</p>
          <button onClick={() => window.location.reload()} className="mt-6 px-6 py-2 bg-emerald-500 text-black rounded-lg font-bold">é‡æ–°è¼‰å…¥</button>
        </div>
      );

      // --- èº«åˆ†èªé ˜ç•«é¢ ---
      if (!currentUser) return (
        <div className="min-h-screen flex items-center justify-center p-6 pb-20">
          <div className="w-full max-w-md bg-[#171C1A] border border-emerald-900/50 rounded-2xl p-8 shadow-2xl">
            {isRegistering ? (
              <div className="animate-in fade-in slide-in-from-right duration-300">
                <div className="flex items-center gap-2 mb-6">
                  <button onClick={() => setIsRegistering(false)} className="p-1 rounded-lg hover:bg-[#2d3a35] transition-colors"><ChevronRight className="w-6 h-6 rotate-180 text-gray-400" /></button>
                  <h1 className="text-xl font-bold">è¨»å†Šæ–°éšŠå“¡</h1>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="text-xs font-bold text-gray-500 mb-2 block">å§“å (è«‹è¼¸å…¥éšŠä¸Šç¶½è™Ÿ)</label>
                    <input 
                      type="text" 
                      value={newUserName}
                      onChange={(e) => setNewUserName(e.target.value)}
                      placeholder="ç‹å°æ˜"
                      className="w-full bg-[#0d1f18] border border-emerald-900/50 rounded-xl px-4 py-3 font-bold focus:outline-none focus:border-emerald-500 transition-all placeholder:text-gray-700"
                    />
                  </div>
                  <button 
                    onClick={handleRegister} 
                    disabled={isSaving || !newUserName.trim()}
                    className="w-full py-4 bg-emerald-500 hover:bg-emerald-400 text-[#0a1a12] rounded-xl font-black shadow-lg disabled:opacity-50 disabled:grayscale transition-all active:scale-95 flex items-center justify-center gap-2"
                  >
                    {isSaving ? <Loader2 className="w-5 h-5 animate-spin" /> : <UserPlus className="w-5 h-5" />}
                    ç¢ºèªè¨»å†Š
                  </button>
                </div>
              </div>
            ) : (
              <div className="animate-in fade-in slide-in-from-left duration-300">
                <h1 className="text-2xl font-bold text-center mb-6">èº«åˆ†èªé ˜</h1>
                <div className="space-y-2 max-h-[50vh] overflow-y-auto mb-4">
                  {profiles
                    .filter(p => !p.lineId) // åªé¡¯ç¤ºæœªç¶å®šçš„èº«åˆ†
                    .map(p => (
                    <button 
                      key={p.name} 
                      onClick={() => handleBindUser(p.name)} 
                      disabled={isSaving}
                      className={`w-full p-4 bg-[#0d1f18] border border-emerald-900/30 rounded-xl text-left flex justify-between items-center group transition-all ${isSaving ? 'opacity-50 cursor-not-allowed' : 'hover:border-emerald-500/50'}`}
                    >
                      <span className="font-bold">{p.name}</span>
                      {isSaving && bindingTarget === p.name ? (
                        <Loader2 className="w-5 h-5 text-emerald-500 animate-spin" />
                      ) : (
                        <ChevronRight className="w-4 h-4 text-gray-600 group-hover:text-emerald-500" />
                      )}
                    </button>
                  ))}
                  {/* æ–°å¢èº«åˆ†æŒ‰éˆ•ç§»å…¥åˆ—è¡¨åº•éƒ¨ */}
                  <button 
                    onClick={() => setIsRegistering(true)}
                    className="w-full p-4 border-2 border-dashed border-emerald-900/50 rounded-xl text-emerald-500 font-bold hover:bg-[#0d1f18] transition-all flex items-center justify-center gap-2 mt-4"
                  >
                    <UserPlus className="w-5 h-5" />
                    æ‰¾ä¸åˆ°åå­—ï¼Ÿè¨»å†Šæ–°éšŠå“¡
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );

      // --- ä¸»ç•«é¢ ---
      return (
        <div className="min-h-screen font-sans pb-32">
          <Confetti isActive={showConfetti} />

          {/* å°è¦½åˆ— */}
          <nav className="sticky top-0 z-40 bg-[#0D1210]/95 backdrop-blur-md border-b border-emerald-900/30 h-16 flex items-center justify-between px-4">
            <div className="flex bg-[#0d1f18] p-1 rounded-xl">
              <button onClick={() => setActiveTab('signup')} className={`px-3 py-2 rounded-lg font-bold text-xs ${activeTab === 'signup' ? 'bg-emerald-500 text-[#0a1a12]' : 'text-gray-500'}`}>æˆ‘è¦å ±å</button>
              <button onClick={() => setActiveTab('dashboard')} className={`px-3 py-2 rounded-lg font-bold text-xs ${activeTab === 'dashboard' ? 'bg-emerald-500 text-[#0a1a12]' : 'text-gray-500'}`}>å‡ºå¸­çœ‹æ¿</button>
              <button onClick={() => setActiveTab('leaderboard')} className={`px-3 py-2 rounded-lg font-bold text-xs ${activeTab === 'leaderboard' ? 'bg-emerald-500 text-[#0a1a12]' : 'text-gray-500'}`}>æ’è¡Œæ¦œ</button>
            </div>
            <div className="text-right">
              <div className="text-[10px] text-emerald-500 font-bold uppercase">User</div>
              <div className="text-sm font-bold">{currentUser.name}</div>
            </div>
          </nav>

          <main className="max-w-4xl mx-auto px-4 py-6">
            {/* åˆ†é  1: æˆ‘è¦å ±å */}
            {activeTab === 'signup' && (
              <div className="animate-in fade-in slide-in-from-bottom-3 duration-500">
                <div className="bg-[#171C1A] p-4 rounded-2xl border border-emerald-900/30 mb-8">
                  <label className="text-[10px] font-bold text-emerald-500 uppercase block mb-2">ä»£ç†äººæ¨¡å¼ (åˆ‡æ›èº«ä»½)</label>
                  <div className="relative">
                    <select value={proxyUser.name} onChange={(e) => setProxyUser(profiles.find(p => p.name === e.target.value))} className="w-full bg-[#0d1f18] border border-emerald-900/50 rounded-xl px-4 py-3 text-sm font-bold focus:outline-none appearance-none">
                      {profiles.map(p => <option key={p.name} value={p.name}>{p.name}{p.name === currentUser.name ? ' (æœ¬äºº)' : ''}</option>)}
                    </select>
                    <ArrowRightLeft className="absolute right-4 top-3.5 w-4 h-4 text-emerald-500/50 pointer-events-none" />
                  </div>
                </div>

                {/* æœˆä»½ Tabs */}
                {availableMonths.length > 0 && (
                  <div className="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-1">
                    {availableMonths.map(m => (
                      <button 
                        key={m} 
                        onClick={() => setSelectedMonth(m)}
                        className={`px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap border transition-colors ${selectedMonth === m ? 'bg-emerald-500 text-[#0a1a12] border-emerald-500' : 'bg-[#171C1A] text-gray-400 border-emerald-900/30 hover:text-emerald-500'}`}
                      >
                        {m}æœˆ
                      </button>
                    ))}
                  </div>
                )}

                <div className="space-y-3">
                  {filteredDates.length === 0 && <div className="text-center text-gray-500 py-4">æœ¬æœˆç„¡è¡Œç¨‹</div>}
                  {filteredDates.map(date => {
                    const isAttending = ['åƒåŠ ', 'æº–æ™‚', 'é²åˆ°'].includes(attendance[`${proxyUser.name}_${date}`]);
                    const locked = isDateLocked(date);

                    return (
                      <div 
                        key={date} 
                        onClick={() => toggleAttendance(date)} 
                        className={`bg-[#171C1A] border rounded-2xl p-4 flex items-center justify-between transition-all ${locked ? 'border-gray-800 opacity-40 grayscale pointer-events-none' : 'border-emerald-900/20 cursor-pointer active:scale-[0.98]'}`}
                      >
                        <div className="flex items-center gap-4">
                          <div className={`w-12 h-12 rounded-xl flex items-center justify-center border ${isAttending ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-gray-800/30 border-gray-700/30'}`}>
                            {locked ? <Lock className="w-5 h-5 text-gray-600" /> : <Calendar className={`w-5 h-5 ${isAttending ? 'text-emerald-500' : 'text-gray-600'}`} />}
                          </div>
                          <div className="font-bold">{date}</div>
                        </div>
                        <div className={`relative w-14 h-8 rounded-full transition-colors ${isAttending ? 'bg-emerald-500' : 'bg-gray-700'}`}><div className={`absolute top-1 left-1 w-6 h-6 bg-white rounded-full transition-transform ${isAttending ? 'translate-x-6' : 'translate-x-0'}`} /></div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* åˆ†é  2: å‡ºå¸­çœ‹æ¿ */}
            {activeTab === 'dashboard' && (
              <div className="animate-in fade-in slide-in-from-bottom-3 duration-500">
                <div className="sticky top-16 z-30 bg-[#151716]/95 backdrop-blur shadow-sm -mx-4 px-4 py-2 mb-6 border-b border-emerald-900/30">
                  <div className="flex items-center gap-2 bg-[#171C1A] p-4 rounded-2xl border border-emerald-900/30">
                    <div className="flex-1 flex flex-col justify-center relative">
                      <h2 className="font-bold text-gray-400 text-xs mb-1">é¸æ“‡æ—¥æœŸ</h2>
                      <div className="relative flex items-center">
                        <select value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="w-full bg-transparent font-bold text-emerald-400 focus:outline-none text-sm appearance-none pr-8 relative z-10">
                          {practiceDates.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                        <div className="absolute right-0 pointer-events-none flex flex-col items-center justify-center opacity-50">
                          <ChevronDown className="w-4 h-4 text-emerald-500" />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-3 mb-8 text-center">
                  <div className="bg-[#171C1A] p-4 rounded-2xl border border-emerald-900/20"><div className="text-[10px] text-gray-500 font-bold mb-1">ç¸½å‡ºå¸­</div><div className="text-2xl font-black text-emerald-400">{dashboardStats.total}</div></div>
                  <div className="bg-[#171C1A] p-4 rounded-2xl border border-emerald-900/20"><div className="text-[10px] text-gray-500 font-bold mb-1">ç”·ç”Ÿ</div><div className="text-2xl font-black text-emerald-400">{dashboardStats.male}</div></div>
                  <div className="bg-[#171C1A] p-4 rounded-2xl border border-emerald-900/20"><div className="text-[10px] text-gray-500 font-bold mb-1">å¥³ç”Ÿ</div><div className="text-2xl font-black text-emerald-400">{dashboardStats.female}</div></div>
                </div>
                
                {/* Refresh æŒ‰éˆ•ç§»è‡³æ­¤è™• */}
                <div className="flex justify-end mb-2 px-1">
                   <button onClick={handleRefresh} className="text-[10px] text-gray-500 flex items-center gap-1 hover:text-white transition-colors cursor-pointer">
                      <RefreshCcw className={`w-3 h-3 ${isRefreshing ? 'animate-spin' : ''}`} /> æ›´æ–°æ•¸æ“š
                   </button>
                </div>

                <div className="space-y-6">
                  {dashboardStats.manifest.Staff.length > 0 && (
                    <div className="bg-emerald-500/5 border border-emerald-500/20 rounded-2xl p-5">
                      <div className="flex items-center gap-2 mb-3 text-emerald-400 text-[10px] font-bold uppercase"><Ship className="w-4 h-4" /> èˆµæ‰‹èˆ‡é¼“æ‰‹</div>
                      <div className="grid grid-cols-2 gap-3">
                        {dashboardStats.manifest.Staff.map(p => (
                          <div key={p.name} className="flex items-center justify-between p-2 bg-[#0d1f18] border border-emerald-500/30 rounded-lg">
                            <span className="text-sm font-bold truncate">{p.name}</span>
                            <StatusBadge name={p.name} />
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  <div className="grid grid-cols-2 gap-4">
                    {['Left', 'Right'].map(side => (
                      <div key={side} className="space-y-3">
                        <div className="text-[10px] font-bold text-gray-500 uppercase">{side === 'Left' ? 'å·¦æ§³' : 'å³æ§³'}</div>
                        {dashboardStats.manifest[side].map(p => (
                          <div key={p.name} className="p-3 bg-[#171C1A] rounded-xl flex justify-between items-center text-sm font-bold shadow-sm border border-emerald-900/20">
                            <span className="truncate">{p.name}</span>
                            <StatusBadge name={p.name} />
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* åˆ†é  3: æ’è¡Œæ¦œ (æ•´åˆæ–°ä»‹é¢) */}
            {activeTab === 'leaderboard' && (
              <div className="animate-in fade-in slide-in-from-bottom-3 duration-500">
                <div className="bg-[#171C1A] p-1 rounded-xl flex gap-1 mb-8 border border-emerald-900/30">
                  <button 
                    onClick={() => setLeaderboardTab('attendance')}
                    className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${
                      leaderboardTab === 'attendance' 
                        ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/50' 
                        : 'text-gray-500 hover:text-emerald-500'
                    }`}
                  >
                    <Trophy className="w-3 h-3" /> æ¦®è€€æ®¿å ‚
                  </button>
                  <button 
                    onClick={() => setLeaderboardTab('sponsor')}
                    className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${
                      leaderboardTab === 'sponsor' 
                        ? 'bg-orange-600 text-white shadow-lg shadow-orange-900/50' 
                        : 'text-gray-500 hover:text-orange-500'
                    }`}
                  >
                    <Coins className="w-3 h-3" /> è´ŠåŠ©æ¦œ
                  </button>
                </div>

                <div className="min-h-[400px]">
                  {!unlockedStatus[leaderboardTab] ? (
                    <div className="flex flex-col items-center justify-center py-16 space-y-8 animate-in fade-in zoom-in duration-500">
                      <ChargeButton 
                        onClick={handleCharge} 
                        progress={energy} 
                        theme={THEMES[leaderboardTab]}
                        icon={leaderboardTab === 'attendance' ? Zap : Coins}
                      />
                      <div className="text-center space-y-1">
                        <p className="text-white font-bold text-lg tracking-wide">
                          {leaderboardTab === 'attendance' ? "æ­æ›‰åˆ’èˆ¹ç‹" : "æ­æ›‰è´ŠåŠ©æ¦œ"}
                        </p>
                        <p className="text-xs text-gray-500 font-medium">
                          é»æ“ŠæŒ‰éˆ•æ³¨å…¥èƒ½é‡ ({energy}%)
                        </p>
                      </div>
                    </div>
                  ) : (
                    leaderboardTab === 'attendance' ? renderAttendanceBoard() : renderSponsorBoard()
                  )}
                </div>
              </div>
            )}
          </main>

          {activeTab === 'signup' && (
            <div className="fixed bottom-8 left-0 right-0 px-6 z-50 flex justify-center">
              <button 
                onClick={handleUpdate} 
                disabled={isSaving || !hasUnsavedChanges} 
                className="w-full max-w-sm flex items-center justify-center gap-3 px-8 py-4 bg-emerald-500 hover:bg-emerald-400 text-[#0a1a12] rounded-2xl font-black shadow-2xl disabled:opacity-50 disabled:grayscale transition-all active:scale-95"
              >
                {isSaving ? <div className="w-5 h-5 border-2 border-[#0a1a12]/30 border-t-[#0a1a12] rounded-full animate-spin" /> : <Save className="w-5 h-5" />}
                {hasUnsavedChanges ? `å„²å­˜ â€${proxyUser?.name}â€œ è³‡æ–™` : "ç„¡è®Šæ›´"}
              </button>
            </div>
          )}
          
          {activeTab === 'dashboard' && (
            <div className="fixed bottom-8 right-6 z-50">
              <button onClick={handleCopyExcel} className="flex items-center gap-3 px-8 py-4 bg-emerald-500 hover:bg-emerald-400 text-[#0a1a12] rounded-2xl font-black shadow-2xl transition-all active:scale-95">
                <Copy className="w-5 h-5" />
                è¤‡è£½åå–®
              </button>
            </div>
          )}
          {toast && <div className="fixed top-24 left-1/2 -translate-x-1/2 bg-emerald-500 text-[#0a1a12] px-6 py-3 rounded-full font-bold shadow-2xl flex items-center gap-2 animate-in slide-in-from-top-4 z-[100]"><CheckCircle2 className="w-4 h-4" />{toast}</div>}
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
